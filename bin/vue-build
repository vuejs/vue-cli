#!/usr/bin/env node

var fs = require('fs')
var path = require('path')
var program = require('commander')
var webpack = require('webpack')
var Server = require('webpack-dev-server')
var webpackMerge = require('webpack-merge')
var HtmlWebpackPlugin = require('html-webpack-plugin')
var FriendlyErrorsPlugin = require('friendly-errors-webpack-plugin')
var PostCompilePlugin = require('post-compile-webpack-plugin')
var ProgressPlugin = require('webpack/lib/ProgressPlugin')
var ExtractTextPlugin = require('extract-text-webpack-plugin')
var loaders = require('../lib/loaders')

/**
 * Usage.
 */

program
  .usage('[entry]')
  .option('--port [port]', 'Server port', 4000)
  .option('--prod, --production', 'Build for production', false)
  .option('--config [directory]', 'Use custom config directory')
  .option('--no-config', 'You do not want global and local config')
  .parse(process.argv)

var args = program.args
var production = program.production

process.env.NODE_ENV = production ? 'production' : 'development'

// load config and webpack config from ~/.vue
var configContext = program.config ? process.cwd() : require('user-home')
var configDirectory = program.config || '.vue'
var localConfigPath = path.join(configContext, configDirectory, 'config.js')
var localWebpackConfigPath = path.join(configContext, configDirectory, 'webpack.config.js')
var localConfig
var localWebpackConfig

if (program.config !== false) {
  var hasLocalConfig = fs.existsSync(localConfigPath)
  var hasLocalWebpackConfig = fs.existsSync(localWebpackConfigPath)
  if (hasLocalConfig) {
    localConfig = require(localConfigPath)
  }
  if (hasLocalWebpackConfig) {
    localWebpackConfig = require(localWebpackConfigPath)
  }
}

var options = Object.assign({
  entry: args[0] || 'index.js',
  port: program.port
}, localConfig)

var cssOptions = {
  extract: production,
  sourceMap: true
}

var webpackConfig = {
  entry: {
    client: []
  },
  output: {
    path: path.join(process.cwd(), 'dist'),
    filename: production ? '[name].[chunkhash:8].js' : '[name].js',
    publicPath: '/'
  },
  performance: {
    hints: false
  },
  resolve: {
    extensions: ['.js', '.vue'],
    modules: [
      path.join(__dirname, '../node_modules'),
      path.join(process.cwd(), 'node_modules'),
      process.cwd()
    ],
    alias: {}
  },
  resolveLoader: {
    modules: [
      path.join(__dirname, '../node_modules'),
      path.join(process.cwd(), 'node_modules')
    ]
  },
  module: {
    rules: [
      {
        test: /\.js$/,
        loader: 'buble-loader',
        exclude: [/node_modules/]
      },
      {
        test: /\.vue$/,
        loader: 'vue-loader',
        options: {
          loaders: Object.assign({
            js: 'buble-loader'
          }, loaders.cssLoaders(cssOptions))
        }
      }
    ].concat(loaders.styleLoaders(cssOptions))
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: path.join(__dirname, '../lib/template.html')
    }),
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV)
    }),
    new webpack.LoaderOptionsPlugin({
      options: {
        context: process.cwd(),
        buble: {
          objectAssign: 'Object.assign',
          transforms: {
            dangerousForOf: false,
            modules: false
          }
        }
      }
    })
  ]
}

if (/\.vue$/.test(options.entry) || options.component) {
  webpackConfig.entry.client.push(path.join(__dirname, '../lib/default-entry'))
  webpackConfig.resolve.alias['your-tasteful-component'] = options.entry
} else {
  webpackConfig.entry.client.push(options.entry)
}

if (production) {
  webpackConfig.devtool = 'source-map'
  webpackConfig.plugins.push(
    new ProgressPlugin(),
    new webpack.optimize.UglifyJsPlugin({
      sourceMap: true,
      compressor: {
        warnings: false
      },
      output: {
        comments: false
      }
    }),
    new webpack.LoaderOptionsPlugin({
      minimize: true
    }),
    new ExtractTextPlugin('[name].[contenthash:8].css')
  )
} else {
  webpackConfig.devtool = 'eval-source-map'
  webpackConfig.entry.client.push(
    require.resolve('webpack-dev-server/client'),
    require.resolve('webpack/hot/dev-server')
  )
  webpackConfig.plugins.push(
    new webpack.HotModuleReplacementPlugin(),
    new FriendlyErrorsPlugin(),
    new PostCompilePlugin(() => {
      console.log(`> Open http://localhost:${options.port}`)
    })
  )
}

// apply custom webpack config
if (localWebpackConfig) {
  webpackConfig.resolve.modules.push(path.join(configContext, configDirectory))
  webpackConfig.resolveLoader.modules.push(path.join(configContext, configDirectory, 'node_modules'))
  webpackConfig = webpackMerge(webpackConfig, localWebpackConfig)
}

var compiler = webpack(webpackConfig)

if (production) {
  compiler.run((err, stats) => {
    if (err) {
      process.exitCode = 1
      return console.error(err.stack)
    }
    if (stats.hasErrors() || stats.hasWarnings()) {
      process.exitCode = 1
      return console.error(stats.toString('errors-only'))
    }
    console.log(stats.toString({
      chunks: false,
      children: false,
      modules: false,
      colors: true
    }))
  })
} else {
  var server = new Server(compiler, Object.assign({
    quiet: true,
    hot: true,
    inline: true
  }, options.devServer))

  server.listen(options.port)
}
